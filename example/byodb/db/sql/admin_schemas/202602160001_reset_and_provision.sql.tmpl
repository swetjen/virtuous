-- +goose Up
-- +goose NO TRANSACTION
SELECT pg_terminate_backend(pid)
FROM pg_stat_activity
WHERE datname = '__PG_DB__'
  AND pid <> pg_backend_pid();

DROP DATABASE IF EXISTS "__PG_DB__";

-- +goose StatementBegin
DO
$$
BEGIN
    IF NOT EXISTS (SELECT 1 FROM pg_roles WHERE rolname = '__PG_USER__') THEN
        EXECUTE 'CREATE ROLE "__PG_USER__"';
    END IF;
END;
$$;
-- +goose StatementEnd

ALTER ROLE "__PG_USER__"
    WITH LOGIN
    ENCRYPTED PASSWORD '__PG_PASS__';

ALTER ROLE "__PG_USER__" SET client_encoding TO 'utf8';
ALTER ROLE "__PG_USER__" SET default_transaction_isolation TO 'read committed';
ALTER ROLE "__PG_USER__" SET timezone TO 'UTC';

CREATE DATABASE "__PG_DB__" OWNER "__PG_USER__";
GRANT ALL PRIVILEGES ON DATABASE "__PG_DB__" TO "__PG_USER__";

-- +goose Down
-- +goose NO TRANSACTION
SELECT pg_terminate_backend(pid)
FROM pg_stat_activity
WHERE datname = '__PG_DB__'
  AND pid <> pg_backend_pid();

DROP DATABASE IF EXISTS "__PG_DB__";
